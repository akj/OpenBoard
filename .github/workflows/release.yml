name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0

# Write permissions needed to create releases
permissions:
  contents: write

jobs:
  # Build for Linux
  build-linux:
    name: Build Linux
    uses: ./.github/workflows/setup-build.yml
    with:
      os: ubuntu-latest
      artifact-retention-days: 0  # Indefinite retention for release artifacts
    permissions:
      contents: read
      actions: read

  # Build for macOS
  build-macos:
    name: Build macOS
    uses: ./.github/workflows/setup-build.yml
    with:
      os: macos-latest
      artifact-retention-days: 0  # Indefinite retention for release artifacts
    permissions:
      contents: read
      actions: read

  # Build for Windows
  build-windows:
    name: Build Windows
    uses: ./.github/workflows/setup-build.yml
    with:
      os: windows-latest
      artifact-retention-days: 0  # Indefinite retention for release artifacts
    permissions:
      contents: read
      actions: read

  # Validate all platform builds before release
  validate-linux:
    name: Validate Linux
    needs: build-linux
    uses: ./.github/workflows/setup-validate-executable.yml
    with:
      os: ubuntu-latest
      artifact-name: openboard-linux
    permissions:
      contents: read
      actions: read

  validate-macos:
    name: Validate macOS
    needs: build-macos
    uses: ./.github/workflows/setup-validate-executable.yml
    with:
      os: macos-latest
      artifact-name: openboard-macos
    permissions:
      contents: read
      actions: read

  validate-windows:
    name: Validate Windows
    needs: build-windows
    uses: ./.github/workflows/setup-validate-executable.yml
    with:
      os: windows-latest
      artifact-name: openboard-windows
    permissions:
      contents: read
      actions: read

  # Create GitHub release with all artifacts (only if validations pass)
  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-macos, build-windows, validate-linux, validate-macos, validate-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Download all artifacts
      uses: actions/download-artifact@v5
      with:
        path: release-artifacts

    - name: Display artifact structure
      run: |
        ls -R release-artifacts/

    - name: Prepare release files
      run: |
        mkdir -p release-files

        # Copy executables
        cp release-artifacts/openboard-linux/*.tar.gz release-files/
        cp release-artifacts/openboard-macos/*.tar.gz release-files/
        cp release-artifacts/openboard-windows/*.zip release-files/

        # Copy checksums and rename with platform suffix
        cp release-artifacts/openboard-linux-checksum/OpenBoard.sha256 release-files/OpenBoard-linux.sha256
        cp release-artifacts/openboard-macos-checksum/OpenBoard.sha256 release-files/OpenBoard-macos.sha256
        cp release-artifacts/openboard-windows-checksum/OpenBoard.sha256 release-files/OpenBoard-windows.sha256

        # Create combined checksums file
        cat release-files/OpenBoard-linux.sha256 > release-files/SHA256SUMS
        cat release-files/OpenBoard-macos.sha256 >> release-files/SHA256SUMS
        cat release-files/OpenBoard-windows.sha256 >> release-files/SHA256SUMS

        echo "Release files prepared:"
        ls -lh release-files/

    - name: Extract version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: OpenBoard ${{ steps.version.outputs.version }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          release-files/*.tar.gz
          release-files/*.zip
          release-files/SHA256SUMS
          release-files/OpenBoard-linux.sha256
          release-files/OpenBoard-macos.sha256
          release-files/OpenBoard-windows.sha256
        body: |
          ## OpenBoard ${{ steps.version.outputs.version }}

          ### Downloads

          - **Linux**: `OpenBoard-linux-x64.tar.gz`
          - **macOS**: `OpenBoard-macos-x64.tar.gz`
          - **Windows**: `OpenBoard-windows-x64.zip`

          ### Installation

          #### Linux
          ```bash
          tar -xzf OpenBoard-linux-x64.tar.gz
          cd OpenBoard
          ./OpenBoard
          ```

          #### macOS
          ```bash
          tar -xzf OpenBoard-macos-x64.tar.gz
          # Move to Applications or run directly
          open OpenBoard.app
          ```

          #### Windows
          Extract the ZIP file and run `OpenBoard.exe`

          ### Verification

          Verify the download integrity using the provided SHA256 checksums:
          ```bash
          sha256sum -c SHA256SUMS
          ```

          ### Requirements

          - Python 3.12 or higher (bundled in executables)
          - Stockfish chess engine (optional, can be installed separately)

          ---

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.ref_name }}
