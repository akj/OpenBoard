name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0

# Write permissions needed to create releases
permissions:
  contents: write

jobs:
  # Build for Linux
  build-linux:
    name: Build Linux
    uses: ./.github/workflows/setup-build.yml
    with:
      os: ubuntu-latest
      artifact-retention-days: 0  # Indefinite retention for release artifacts
    permissions:
      contents: read
      actions: read

  # Build for macOS
  build-macos:
    name: Build macOS
    uses: ./.github/workflows/setup-build.yml
    with:
      os: macos-latest
      artifact-retention-days: 0  # Indefinite retention for release artifacts
    permissions:
      contents: read
      actions: read

  # Build for Windows
  build-windows:
    name: Build Windows
    uses: ./.github/workflows/setup-build.yml
    with:
      os: windows-latest
      artifact-retention-days: 0  # Indefinite retention for release artifacts
    permissions:
      contents: read
      actions: read

  # Validate all platform builds before release
  validate-linux:
    name: Validate Linux
    needs: build-linux
    uses: ./.github/workflows/setup-validate-executable.yml
    with:
      os: ubuntu-latest
      artifact-name: openboard-linux
    permissions:
      contents: read
      actions: read

  validate-macos:
    name: Validate macOS
    needs: build-macos
    uses: ./.github/workflows/setup-validate-executable.yml
    with:
      os: macos-latest
      artifact-name: openboard-macos
    permissions:
      contents: read
      actions: read

  validate-windows:
    name: Validate Windows
    needs: build-windows
    uses: ./.github/workflows/setup-validate-executable.yml
    with:
      os: windows-latest
      artifact-name: openboard-windows
    permissions:
      contents: read
      actions: read

  # Build installers (only if validations pass)
  build-installer-linux:
    name: Build Linux Installers
    needs: validate-linux
    uses: ./.github/workflows/setup-build-installer.yml
    with:
      os: ubuntu-latest
      artifact-name: openboard-linux
      installer-type: deb,rpm
    permissions:
      contents: read
      actions: read

  build-installer-macos:
    name: Build macOS Installer
    needs: validate-macos
    uses: ./.github/workflows/setup-build-installer.yml
    with:
      os: macos-latest
      artifact-name: openboard-macos
      installer-type: dmg
    permissions:
      contents: read
      actions: read

  build-installer-windows:
    name: Build Windows Installer
    needs: validate-windows
    uses: ./.github/workflows/setup-build-installer.yml
    with:
      os: windows-latest
      artifact-name: openboard-windows
      installer-type: innosetup
    permissions:
      contents: read
      actions: read

  # Create GitHub release with all artifacts (only if validations pass)
  create-release:
    name: Create GitHub Release
    needs: [
      build-linux, build-macos, build-windows,
      validate-linux, validate-macos, validate-windows,
      build-installer-linux, build-installer-macos, build-installer-windows
    ]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Download all artifacts
      uses: actions/download-artifact@v5
      with:
        path: release-artifacts

    - name: Display artifact structure
      run: |
        ls -R release-artifacts/

    - name: Prepare release files
      run: |
        mkdir -p release-files

        # Copy installers (primary distribution method)
        cp release-artifacts/openboard-linux-installer/*.deb release-files/ 2>/dev/null || echo "No DEB package found"
        cp release-artifacts/openboard-linux-installer/*.rpm release-files/ 2>/dev/null || echo "No RPM package found"
        cp release-artifacts/openboard-macos-installer/*.dmg release-files/ 2>/dev/null || echo "No DMG found"
        cp release-artifacts/openboard-windows-installer/*.exe release-files/ 2>/dev/null || echo "No Windows installer found"

        # Copy archives (fallback/portable distribution method)
        cp release-artifacts/openboard-linux/*.tar.gz release-files/
        cp release-artifacts/openboard-macos/*.tar.gz release-files/
        cp release-artifacts/openboard-windows/*.zip release-files/

        # Copy checksums and rename with platform suffix
        cp release-artifacts/openboard-linux-checksum/OpenBoard.sha256 release-files/OpenBoard-linux.sha256
        cp release-artifacts/openboard-macos-checksum/OpenBoard.sha256 release-files/OpenBoard-macos.sha256
        cp release-artifacts/openboard-windows-checksum/OpenBoard.sha256 release-files/OpenBoard-windows.sha256

        # Create combined checksums file
        cat release-files/OpenBoard-linux.sha256 > release-files/SHA256SUMS
        cat release-files/OpenBoard-macos.sha256 >> release-files/SHA256SUMS
        cat release-files/OpenBoard-windows.sha256 >> release-files/SHA256SUMS

        echo "Release files prepared:"
        ls -lh release-files/

    - name: Extract version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: OpenBoard ${{ steps.version.outputs.version }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          release-files/*.deb
          release-files/*.rpm
          release-files/*.dmg
          release-files/*.exe
          release-files/*.tar.gz
          release-files/*.zip
          release-files/SHA256SUMS
          release-files/OpenBoard-linux.sha256
          release-files/OpenBoard-macos.sha256
          release-files/OpenBoard-windows.sha256
        body: |
          ## OpenBoard ${{ steps.version.outputs.version }}

          ### Downloads (Recommended Installers)

          - **Windows**: `OpenBoard-v{version}-windows-x64-setup.exe` - Professional installer with Start Menu integration
          - **macOS**: `OpenBoard-v{version}-macos-x64.dmg` - Drag-to-Applications installer
          - **Linux (Debian/Ubuntu)**: `openboard_{version}_amd64.deb` - Native package manager support
          - **Linux (Fedora/RHEL)**: `openboard-{version}-1.x86_64.rpm` - RPM package manager support

          ### Portable Archives (Advanced Users)

          If you prefer portable versions without installation:
          - **Linux**: `OpenBoard-linux-x64.tar.gz`
          - **macOS**: `OpenBoard-macos-x64.tar.gz`
          - **Windows**: `OpenBoard-windows-x64.zip`

          ### Installation

          #### Windows
          Run the installer (`OpenBoard-v{version}-windows-x64-setup.exe`) and follow the setup wizard.
          Optionally create desktop shortcut and associate .PGN files.

          #### macOS
          1. Open the DMG file
          2. Drag OpenBoard.app to the Applications folder
          3. Launch from Applications or Launchpad

          #### Linux (Debian/Ubuntu)
          ```bash
          sudo dpkg -i openboard_{version}_amd64.deb
          sudo apt-get install -f  # Install dependencies if needed
          ```

          #### Linux (Fedora/RHEL)
          ```bash
          sudo rpm -ivh openboard-{version}-1.x86_64.rpm
          ```

          #### Portable Archives (Linux)
          ```bash
          tar -xzf OpenBoard-linux-x64.tar.gz
          cd OpenBoard
          ./OpenBoard
          ```

          #### Portable Archives (macOS)
          ```bash
          tar -xzf OpenBoard-macos-x64.tar.gz
          open OpenBoard.app
          ```

          #### Portable Archives (Windows)
          Extract the ZIP file and run `OpenBoard.exe`

          ### Verification

          Verify download integrity using SHA256 checksums:
          ```bash
          sha256sum -c SHA256SUMS
          ```

          ### Requirements

          - **Linux**: GTK 3, speech-dispatcher, espeak-ng (handled by package managers)
          - **macOS**: macOS 12 or later
          - **Windows**: Windows 10 or later
          - **Optional**: Stockfish chess engine (can be installed separately)

          ---

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.ref_name }}
